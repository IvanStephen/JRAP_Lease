<!--
  ~ /**
  ~ * @file com.maddyhome.idea.copyright.pattern.FileInfo@550526fb$
  ~ * @CopyRight (C) 2018 ZheJiangJingRui Co. Ltd.
  ~ * @brief JingRui Application Platform
  ~ * @author $name$
  ~ * @email yulong.yuan@jr-info.cn
  ~ * @date $date$
  ~ */
  -->

<!--
* description: 租赁物编辑页面
*author:yulong.yuan@jr-info.cn
* version: 1.0
*
-->
<#include "../include/header.html">
<body>
<script src="${base.contextPath}/lib/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<style type="text/css">
  .left {
    margin: 7px;
    width: 16%;
    float: left;
    position: absolute;
    top: 50px;
    bottom: 0px;
    left: 10px;
    background-color: #FFFFFF;
  }

  #treeView {
    height: 100%;
  }

  .right {
    float: right;
    width: 83%;
  }
</style>
<script>
  var isedit = '${RequestParameters.isedit!0}' == '1';
  var itemId = -99;
  var newViewModel = kendo.observable({
    model: {
      companyId: -1,
      enabledFlag: "Y"
    },
  });
  if (isedit) {
    itemId = '${RequestParameters.itemId!0}';
    $.ajax({
      url: '${base.contextPath}/afd/item/query?itemId=' + itemId,
      success: function (args) {
        var a0 = args.rows[0] || {};
        for (var k in a0) {
          newViewModel.model.set(k, a0[k]);
        }
      }
    });
  }

  // 获取生产线的数据源
  var productLineSource;
  (function () {
    $.ajax({
      type: "POST",
      url: '${base.contextPath}/pro/product/line/query',
      dataType: "json",
      data: {"page": "1", "pageSize": "1000000"},
      async: false,
      contentType: "application/x-www-form-urlencoded; charset=UTF-8",
      success: function (data) {
        productLineSource = data.rows;
      }
    });
  })();
</script>

<div id="page-content">
  <div>
    <div id="tabstrip">
      <ul>
        <li class="k-state-active">
          基础信息
        </li>
        <li>
          评估信息
        </li>
      </ul>
      <div>
        <form class="form-horizontal" role="form" style="width: 98%;">
          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label" style="text-align: right"><@spring.message
                  "item.itemCode"/></label>
                <div class="col-xs-8">
                  <input id="itemCode" name="itemCode" type="text" data-role="maskedtextbox"
                         data-label="<@spring.message 'item.itemCode'/>"
                         data-bind="value:model.itemCode"
                         class="k-textbox" disabled
                         style="width: 100%;">
                  <script>kendo.bind($('#itemCode'), newViewModel);</script>
                </div>
              </div>
            </div>

            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label" style="text-align: right"><@spring.message
                  "item.linecode"/></label>
                <div class="col-xs-8">
                  <input id="lineCode" name="lineCode" type="text"
                         data-bind="value:model.lineCode"
                         style="width: 100%;" required
                         data-label="<@spring.message 'item.linecode'/>">
                  <script>
                    $("#lineCode").kendoComboBox({
                      dataSource: productLineSource,
                      valuePrimitive: true,
                      dataTextField: "description",
                      dataValueField: "lineCode",
                      select: function (e) {
                        newViewModel.model.set("lineCode", e.dataItem.value);
                      }
                    });
                    kendo.bind($("#lineCode"), newViewModel);
                  </script>

                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4   control-label"
                       style="text-align: right"><@spring.message "item.model"/></label>
                <div class="col-xs-8">
                  <input id="model" type="text" data-bind="value:model.model"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#model'), newViewModel);</script>
                </div>
              </div>
            </div>

          </div>


          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4   control-label"
                       style="text-align: right"><@spring.message "item.outsidecolor"/></label>
                <div class="col-xs-8">
                  <input id="outsideColor" type="text" data-bind="value:model.outsideColor"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#outsideColor'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.insidecolor"/></label>
                <div class="col-xs-8">
                  <input id="insideColor" type="text" data-bind="value:model.insideColor"
                         class="k-textbox" style="width: 100%;">
                  <script>kendo.bind($('#insideColor'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.vin"/></label>
                <div class="col-xs-8">
                  <input id="vin" type="text" data-bind="value:model.vin"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#vin'), newViewModel);</script>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.enginenumber"/></label>
                <div class="col-xs-8">
                  <input id="engineNumber" type="text" data-bind="value:model.engineNumber"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#engineNumber'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.license"/></label>
                <div class="col-xs-8">
                  <input id="license" type="text" data-bind="value:model.license" class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#license'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.mileage"/></label>
                <div class="col-xs-8">
                  <input id="mileage" type="text" data-bind="value:model.mileage"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#mileage'), newViewModel);</script>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.key"/></label>
                <div class="col-xs-8">
                  <input id="carKey" type="text" data-bind="value:model.carKey"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#carKey'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.guideprice"/></label>
                <div class="col-xs-8">
                  <input id="guidePrice" type="text" data-bind="value:model.guidePrice"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#guidePrice'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.invoiceprice"/></label>
                <div class="col-xs-8">
                  <input id="invoicePrice" type="text" data-bind="value:model.invoicePrice"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#invoicePrice'), newViewModel);</script>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.cartype"/></label>
                <div class="col-xs-8">
                  <input id="carType" type="text" data-bind="value:model.carType"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#carType'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.loantype"/></label>
                <div class="col-xs-8">
                  <input id="loanType" type="text" data-bind="value:model.loanType"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#loanType'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.loanremark"/></label>
                <div class="col-xs-8">
                  <input id="loanRemark" type="text" data-bind="value:model.loanRemark"
                         class="k-textbox"
                         style="width: 100%;">
                  <script>kendo.bind($('#loanRemark'), newViewModel);</script>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.releasedate"/></label>
                <div class="col-xs-8">
                  <input id="releaseDate" style="width: 100%" data-bind="value:model.releaseDate">
                  <script>
                    $('#releaseDate').kendoDatePicker();
                    kendo.bind($('#releaseDate'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.annualdate"/></label>
                <div class="col-xs-8">
                  <input id="annualDate" style="width: 100%" data-bind="value:model.annualDate">
                  <script>
                    $('#annualDate').kendoDatePicker();
                    kendo.bind($('#annualDate'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.insurance"/></label>
                <div class="col-xs-8">
                  <input id="insurance" style="width: 100%" data-bind="value:model.insurance">
                  <script>
                    $('#insurance').kendoDatePicker();
                    kendo.bind($('#insurance'), newViewModel);</script>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xs-12 row">
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"
                       style="text-align: right"><@spring.message "item.drivingdate"/></label>
                <div class="col-xs-8">
                  <input id="drivingDate" style="width: 100%" data-bind="value:model.drivingDate">
                  <script>
                    $('#drivingDate').kendoDatePicker();
                    kendo.bind($('#drivingDate'), newViewModel);</script>
                </div>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group">
                <label class="col-xs-4 control-label"><@spring.message "item.enabledFlag"/>:</label>
                <div class="col-xs-8" style="text-align: left">
                  <input id="enabledFlag" type="checkbox" class="k-checkbox" style="margin-top:5px"
                         data-bind="value:model.enabledFlag">
                </div>
                <script>
                  kendo.bind($('#enabledFlag'), newViewModel);
                  $("#enabledFlag").kendoCheckbox({
                    checkedValue: 'Y',
                    uncheckedValue: 'N'
                  });
                </script>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div style="height:300px;">
        <div class="panel-body">
          <div class="row">
            <div class="left">
              <div id="treeView"></div>
            </div>
            <div class="right">
              <div class="form-group">
                <div id='grid-container'>
                  <div id="evaluategrid" style="clear: both"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="text-right"
       style="bottom: 10px; position: relative; padding-right: 24px;  float: left; padding-top:10px;border-top:1px solid #ebebeb;width:100%; background: #fff;">
    <span class="btn btn-primary" id="saveGrid" type="submit" style="margin-right: 5px;"><@spring.message "jrap.save"/></span>
    <span class="btn btn-default" id="closeWin" type="button" style="margin-right: 25px;"><@spring.message "jrap.cancel"/></span>
  </div>
  <script>
    var tabstrip = $("#tabstrip").kendoTabStrip({
      height: '100%',
      animation: false
    }).data("kendoTabStrip");
    tabstrip.tabGroup.on("click", ".k-i-close", function (e) {
      e.preventDefault();
      e.stopPropagation();
      var item = $(e.target).closest(".k-item");
      var index = item.index(),
          prev = item.next().length == 1 ? item.next() : item.prev();
      tabstrip.remove(item.index());
      tabstrip.select(prev)
    });
  </script>
</div>

<script>
  /*评估信息grid*/
  var viewModel = Jrap.createGridViewModel("#evaluategrid");
  var BaseUrl = _basePath;
  evaluatedataSource = new kendo.data.DataSource({
    transport: {
      read: {
        url: BaseUrl + "/afd/item/evaluate/selectByItemId/" + itemId,
        type: "POST",
        dataType: "json"
      },
      update: {
        url: BaseUrl + "/afd/item/evaluate/submit",
        type: "POST",
        contentType: "application/json"
      },
      destroy: {
        url: BaseUrl + "/afd/item/evaluate/remove",
        type: "POST",
        contentType: "application/json"
      },
      create: {
        url: BaseUrl + "/afd/item/evaluate/submit",
        type: "POST",
        contentType: "application/json"
      },
      parameterMap: function (options, type) {
        if (type !== "read" && options.models) {
          var datas = Jrap.prepareSubmitParameter(options, type);
          return kendo.stringify(datas);
        } else if (type === "read") {
          return Jrap.prepareQueryParameter(viewModel.model.toJSON(), options)
        }
      }
    },
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
      data: 'rows',
      total: 'total',
      model: {
        id: "evaluateId",
        fields: {
          itemId: {defaultValue: itemId},
          enabledFlag: {defaultValue: 'Y', type: 'boolean', checkedValue: 'Y', uncheckedValue: 'N'}
        }
      }
    }
  });

  var grid = $("#evaluategrid").kendoGrid({
    dataSource: evaluatedataSource,
    resizable: true,
    scrollable: true,
    navigatable: false,
    selectable: 'multiple, rowbox',
    dataBound: function () {
      if (parent.autoResizeIframe) {
        parent.autoResizeIframe('${RequestParameters.functionCode!}')
      }
    },
    pageable: {
      pageSizes: [5, 10, 20, 50],
      refresh: true,
      buttonCount: 5
    },
    toolbar: [
      {
        template: '<span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:create"><@spring.message "jrap.new"/></span>'
      },
      {
        template: '<span class="btn btn-success k-grid-save-changes" data-bind="click:save" style="float:left;margin-right:5px;"><@spring.message "jrap.save"/></span>'
      },
      {
        template: '<span  onclick="deleteData()"  class="btn btn-danger"><i class="fa fa-trash-o" style="margin-right:3px;"></i><@spring.message "jrap.delete"/></span>'
      }
    ],
    columns: [
      {
        field: "evaluateType",
        title: '<@spring.message "itemevaluate.evaluatetype"/>',
        width: 120
      },
      {
        field: "evaluationDate",
        title: '<@spring.message "itemevaluate.evaluationdate"/>',
        format: "{0:yyyy-MM-dd hh:mm:ss}",
        editor: function (container, options) {
          var input = $('<input name="' + options.field + '"/>');
          input.appendTo(container);
          input.kendoDateTimePicker({
            format: "yyyy-MM-dd hh:mm:ss"
          });
        },
        width: 120
      },
      {
        field: "evaluator",
        title: '<@spring.message "itemevaluate.evaluator"/>',
        width: 120
      },
      {
        field: "outsideScore",
        title: '<@spring.message "itemevaluate.outsidescore"/>',
        width: 120
      },
      {
        field: "insideScore",
        title: '<@spring.message "itemevaluate.insidescore"/>',
        width: 120
      },
      {
        field: "skeletonScore",
        title: '<@spring.message "itemevaluate.skeletonscore"/>',
        width: 120
      },
      {
        field: "configScore",
        title: '<@spring.message "itemevaluate.configscore"/>',
        width: 120
      },
      {
        field: "compositeScore",
        title: '<@spring.message "itemevaluate.compositescore"/>',
        width: 120
      },
      {
        field: "evaluatePrice",
        title: '<@spring.message "itemevaluate.evaluateprice"/>',
        width: 120
      },
      {
        field: "tradePrice",
        title: '<@spring.message "itemevaluate.tradeprice"/>',
        width: 120
      },
      {
        field: "enabledFlag",
        title: '<@spring.message "itemevaluate.enabledflag"/>',
        headerAttributes: {
          "class": "table-header-cell",
          style: "text-align: center"
        },
        attributes: {style: "text-align:center"},
        width: 120
      },
    ],
    editable: true
  }).data("kendoGrid");
  ;

  function deleteData() {
    var checked = grid.selectedDataItems();

    if (grid.selectedDataItems().length) {
      kendo.ui.showConfirmDialog({
        title: $l('jrap.tip.info'),
        message: $l('jrap.tip.delete_confirm')
      }).done(function (event) {
        if (event.button == 'OK') {
          $.each(checked, function (i, v) {
            grid.dataSource.remove(v)
          });
          grid.dataSource.sync();
        }
      })
    }
  }

  /* 租赁物信息提交验证*/
  var validator = $("#page-content").kendoValidator({
    valid: function (e) {
    },
    invalidMessageType: "tooltip"
  }).data("kendoValidator");

  $("#closeWin").click(function () {
    window.parent.$("#newWin").data("kendoWindow").close();
  });

  $("#saveGrid").click(function () {
    if (validator.validate()) {
      newViewModel.model.__status = isedit ? 'update' : 'add';
      Jrap.submitForm({
        url: '${base.contextPath}/afd/item/submit',
        formModel: newViewModel.model,
        success: function (data) {
          window.parent.$('#grid').data('kendoGrid').dataSource.page(1);
          window.parent.$("#newWin").data("kendoWindow").close();
        }
      });
    }
  });
</script>
</body>
</html>