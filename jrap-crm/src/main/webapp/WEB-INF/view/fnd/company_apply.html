<#include "../include/header.html">
<style>
    * {
        margin: 0;
        padding: 0;
    }

    html, body {
        width: 100%;
        height: 500px;
    }

    #container {
        text-align: left;
        width: 760px;
        min-height: 90vh;
        background-color: #FFFFFF;
        padding: 20px;
    }

    #container #title {
        height: 28px;
    }

    #container #title li {
        float: left;
        list-style-type: none;
        height: 28px;
        line-height: 28px;
        text-align: center;
        margin-right: 1px;
    }

    #container #title ul {
        background-color: #FFFFFF;
        height: 28px;
    }

    #container #title a {
        text-decoration: none;
        color: #000000;
        display: block;
        width: auto;
    }

    #container #title a span {
        display: block;
        padding: 0 15px 0 15px;
        background-color: #4fbdec;
    }

    #container #title #tag1 a:hover {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title #tag1 a:hover span {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title #tag2 a:hover {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title #tag2 a:hover span {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title #tag3 a:hover {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title #tag3 a:hover span {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title #tag4 a:hover {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title #tag4 a:hover span {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title #tag5 a:hover {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title #tag5 a:hover span {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title .selectli1 {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title a .selectspan1 {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title .selectli2 {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title a .selectspan2 {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title .selectli3 {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title a .selectspan3 {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title .selectli4 {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title a .selectspan4 {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #title .selectli5 {
        text-decoration: none;
        color: #ffffff;
        display: block;
        width: auto;
    }

    #container #title a .selectspan5 {
        display: block;
        padding: 0 15px 0 15px;
    }

    #container #content ul {
        margin: 10px;
    }

    #container #content li {
        margin: 5px;
    }

    #container #content li img {
        margin: 5px;
        display: block;
    }

    #container #content {
        margin: 0;
        padding: 0;
    }

    .hidecontent {
        display: none;
    }
    .left{
        margin: 7px;
        width: 16%;
        float: left;
        position: absolute;
        top:50px;
        bottom: 0px;
        left: 10px;
        background-color: #FFFFFF;
    }
    #treeView{
        height: 100%;
    }
    .right{
        float: right;
        width: 83%;
    }
</style>
<script src="${base.contextPath}/lib/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="${base.contextPath}/common/code?limitTypeData=COMPANYLIMIT.LIMIT_TYPE" type="text/javascript"></script>
<script type="text/javascript">
    var companyViewModel = kendo.observable({
        model: {
            status:"SUBMIT"
        },
    });
    var viewModel = Jrap.createGridViewModel("#grid");
    var BaseUrl = _basePath;
    var newViewModel = kendo.observable({
        model: {
        },
        categoryId : "-1",
        sourceType : "COMPANY_ID"
    });
    var companyId = "";
</script>
<div id="container">
    <div id="content">
        <div id="content1" class="content">
            <form class="form-horizontal">
                <div class="col-xs-12">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.companyCode"/></label>
                            <div class="col-xs-8">
                                <input id="companyCode" name="companyCode" type="text" data-role="maskedtextbox"
                                       required
                                       data-label="<@spring.message 'company.companyCode'/>"
                                       data-bind="enabled: model.isEnabled,value:model.companyCode" class="k-textbox"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.companyShortName"/></label>
                            <div class="col-xs-8">
                                <input id="companyShortName" name="companyShortName" type="text"
                                       data-bind="value:model.companyShortName"
                                       style="width: 100%;" required
                                       data-label="<@spring.message 'company.companyShortName'/>"/>
                                <span class="k-invalid-msg" data-for="companyShortName"></span>
                                <script>
                                    $("#companyShortName").kendoTLEdit({
                                        idField: 'companyId',
                                        field: 'companyShortName',
                                        dto: "com.jingrui.jrap.fnd.dto.Company",
                                        model: companyViewModel.model
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12">
                    <div class="col-xs-12">
                        <div class="form-group">
                            <label class="col-xs-2 control-label"
                                   style="text-align: right"><@spring.message "company.companyFullName"/></label>
                            <div class="col-xs-10">
                                <input id="companyFullName" name="companyFullName" type="text"
                                       data-bind="value:model.companyFullName"
                                       style="width: 100%;" required
                                       data-label="<@spring.message 'company.companyFullName'/>">
                                <span class="k-invalid-msg" data-for="companyFullName"></span>

                                <script>
                                    $("#companyFullName").kendoTLEdit({
                                        idField: 'companyId',
                                        field: 'companyFullName',
                                        dto: "com.jingrui.jrap.fnd.dto.Company",
                                        model: companyViewModel.model
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.companyType"/></label>
                            <div class="col-xs-8">
                                <input id="companyType" type="text" data-bind="value:model.companyType"
                                       style="width: 100%;">
                                <script>
                                    $("#companyType").kendoComboBox({
                                        dataTextField: "meaning",
                                        dataValueField: "value",
                                        dataSource: {
                                            transport: {
                                                read: {
                                                    url: _basePath + '/common/code/FND.COMPANY_TYPE/',
                                                    dataType: "json"
                                                }
                                            }
                                        },
                                        select: function (e) {
                                            companyViewModel.model.set("companyType", e.dataItem.value);
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.companyLevelId"/></label>
                            <div class="col-xs-8">
                                <input id="companyLevelId" type="text" data-bind="value:model.companyLevelId"
                                       style="width: 100%;">
                                <script>
                                    $("#companyLevelId").kendoComboBox({
                                        dataTextField: "meaning",
                                        dataValueField: "value",
                                        dataSource: {
                                            transport: {
                                                read: {
                                                    url: _basePath + '/common/code/FND.COMPANY_LEVEL/',
                                                    dataType: "json"
                                                }
                                            }
                                        },
                                        select: function (e) {
                                            companyViewModel.model.set("companyLevelId", e.dataItem.value);
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.companyClass"/></label>
                            <div class="col-xs-8">
                                <input id="companyClass" type="text" data-bind="value:model.companyClass"
                                       style="width: 100%;">
                                <script>
                                    $("#companyClass").kendoComboBox({
                                        dataTextField: "meaning",
                                        dataValueField: "value",
                                        dataSource: {
                                            transport: {
                                                read: {
                                                    url: _basePath + '/common/code/COMPANY.CLASS/',
                                                    dataType: "json"
                                                }
                                            }
                                        },
                                        select: function (e) {
                                            companyViewModel.model.set("companyClass", e.dataItem.value);
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.parentCompanyName"/></label>
                            <div class="col-xs-8">
                                <input type="text" id="parentCompanyId"
                                       style="width:100%;"
                                       data-bind="value:model.parentCompanyId,text:model.parentCompanyName">
                                <script>
                                    $("#parentCompanyId").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "LOV_COMPANY")}, {
                                        query: function (e) {
                                            e.param['enabledFlag'] = 'Y';
                                        }
                                    }));
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "user.startactivedate"/></label>
                            <div class="col-xs-8">
                                <input id="startDateActive" style="width: 100%" data-bind="value:model.startDateActive">
                                <script>
                                    $('#startDateActive').kendoDatePicker();
                                </script>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "user.endactivedate"/></label>
                            <div class="col-xs-8">
                                <input style="width: 100%" id="endDateActive" data-bind="value:model.endDateActive"/>
                                <script>
                                    $('#endDateActive').kendoDatePicker();
                                </script>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.zipcode"/></label>
                            <div class="col-xs-8">
                                <input id="zipcode" type="text" data-bind="value:model.zipcode" class="k-textbox"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.fax"/></label>
                            <div class="col-xs-8">
                                <input id="fax" type="text" data-bind="value:model.fax" class="k-textbox"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4 control-label"
                                   style="text-align: right"><@spring.message "company.phone"/></label>
                            <div class="col-xs-8">
                                <input id="phone" type="text" data-bind="value:model.phone" class="k-textbox"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-4   control-label"
                                   style="text-align: right"><@spring.message "company.contactPerson"/></label>
                            <div class="col-xs-8">
                                <input id="contactPerson" type="text" data-bind="value:model.contactPerson"
                                       class="k-textbox"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12">
                    <div class="col-xs-12">
                        <div class="form-group">
                            <label class="col-xs-2 control-label"
                                   style="text-align: right"><@spring.message "company.address"/></label>
                            <div class="col-xs-10">
                                <input id="address" type="text" data-bind="value:model.address" class="k-textbox"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="text-right">
                <span class="btn btn-primary"  type="button" onclick="content1nextStep()" style="margin-right: 5px;"><@spring.message "下一步"/></span>
                <span class="btn btn-default"  type="button" style="margin-right: 25px;"><@spring.message "jrap.cancel"/></span>
            </div>
        </div>
        <div id="content2" class=" content hidecontent">
            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:create"><@spring.message "jrap.new"/></span>
                <span data-bind="click:remove" class="btn btn-danger" style="float:left;"><@spring.message "jrap.delete"/></span>
            </div>
            <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
            <div style="clear:both">
                <div id="grid"></div>
            </div>
            <div class="text-right">
                <span class="btn btn-primary"  type="button" onclick="content2prevStep()" style="margin-right: 5px;"><@spring.message "上一步"/></span>
                <span class="btn btn-primary"  type="button" onclick="content2nextStep()" style="margin-right: 5px;"><@spring.message "下一步"/></span>
                <span class="btn btn-default"  type="button" style="margin-right: 25px;"><@spring.message "jrap.cancel"/></span>
            </div>
        </div>
        <div id="content3" class=" content hidecontent">
            <div  style="height:300px;">
                <div class="panel-body">
                    <div class="row">
                        <div class="left">
                            <div id="treeView" ></div>
                        </div>

                        <div class="right">
                            <div class="form-group">
                                <div id='grid-container'>
                                    <div id="sysfile_grid" style="clear: both"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <span class="btn btn-primary"  type="button" onclick="content3prevStep()" style="margin-right: 5px;"><@spring.message "上一步"/></span>
                <span class="btn btn-success k-grid-save-changes" type="button" onclick="applySubmit()" style="margin-right:5px;"><@spring.message "提交"/></span>
                <span class="btn btn-default"  type="button" style="margin-right: 25px;"><@spring.message "jrap.cancel"/></span>
            </div>
        </div>
    </div>
</div>
<div id="importWin" style="display: none;">
    <div class="panel" style="border:none;box-shadow: none;">
        <form id="importForm" class="form-horizontal">
            <div class="panel-body">
                <div class="row">
                    <div class="form-group">
                        <label class="col-sm-3 control-label"><@spring.message "attachcategory.sourcetype"/></label>
                        <div class="col-sm-6">
                            <input id="sourceType" type="text" style="width:100%" data-bind="value:sourceType" disabled>
                            <script>kendo.bind($('#sourceType'), newViewModel);</script>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">支撑附件</label>
                        <div class="col-sm-6">
                            <input id="fileUpload" name="fileUpload" type="file" style="width: 100%">
                        </div>
                    </div>
                </div>
                <script>
                    $("#fileUpload").kendoUpload({
                        async: {
                            saveUrl: "${base.contextPath}/sys/attach/upload?${_csrf.parameterName}=${_csrf.token}",
                            autoUpload: true
                        },
                        upload: function (e) {
                            e.data = {
                                sourceType: newViewModel.get("sourceType"),
                                sourceKey: companyId
                            }
                        },
                        success: function(e) {
                            if(e.response.success=== true){
                                var fileType = e;
                            }
                            kendo.ui.showInfoDialog({
                                message  : e.response.message
                            })
                        },
                        showFileList: false
                    });
                </script>
            </div>
        </form>
    </div>
</div>
</body>
<script type="text/javascript">
kendo.bind($('#content1'), companyViewModel);
function  content1nextStep(){
    // 必输校验

    // 保存商户信息并且切换到下一个页面
    $.ajax({
        url: BaseUrl + '/fnd/company/add',
        type: "POST",
        dataType: "json",
        contentType: "application/json;charset=UTF-8",
        data: kendo.stringify(companyViewModel.model),
        success: function (data) {
            if (data.rows.length > 0) {
                var a0 = data.rows[0] || {};
                companyId = a0.companyId;
                $('#content1').addClass("hidecontent");
                $('#content2').removeClass("hidecontent");
            }else {
                kendo.ui.showInfoDialog({
                    title: "提示",
                    message: "商户信息录入失败",
                    iconClass: "fa fa-times-circle", // 提示图标
                    dialogClass: "k-dialog-error" // 图标类型
                });
            }
        },
    });
}
</script>
<script type="text/javascript">
    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/fnd/company/limit/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/fnd/company/limit/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/fnd/company/limit/remove",
                type: "POST",
                contentType: "application/json"
            },
            create:{
                url: BaseUrl + "/fnd/company/limit/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Jrap.prepareSubmitParameter(options, type);
                    for(var i=0;i<datas.length;i++){
                        datas[i].companyId=companyId;
                    }
                    return kendo.stringify(datas);
                } else
                if (type === "read") {
                    viewModel.model.set("companyId",-11123);
                    return Jrap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            },
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "limitId",
                fields: {
                    companyId:{editable: false},
                    limitType:{defaultValue:"COMPANY"},
                    limitDate: {type: 'date'},
                    startDate: {type: 'date'},
                    endDate: {type: 'date', defaultValue: null},
                    limitAmount: {type:"number"},
                    enabledFlag: {defaultValue: 'N', type: 'boolean', checkedValue: 'Y', uncheckedValue: 'N',editable: false}
                }
            }
        }
    });
      $("#grid").kendoGrid({
        dataSource: dataSource,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "companyId",
                title: '<@spring.message "companylimit.companyid"/>',
                width: 120,
                template: function (dataItem) {
                    var v = "";
                    if(companyId!=null){
                        v =companyId
                    }
                    return v;
                },
            },
            {
                field: "limitType",
                title: '<@spring.message "companylimit.limittype"/>',
                width: 120,
                template: function (dataItem) {
                    var v = dataItem.limitType ? dataItem.limitType : "";
                    $.each(limitTypeData, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v;
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoComboBox({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource: limitTypeData
                        });
                }
            },
            {
                field: "limitCompanyId",
                title: '<@spring.message "companylimit.limitcompanyid"/>',
                width: 120,
                template: function (dataItem) {
                    return dataItem['companyFullName'] || ''
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoLov($.extend(<@lov "LOV_COMPANY"/>, {
                        query: function (e) {
                            //e.param['enabledFlag'] = 'Y'
                        },
                        textField: 'companyFullName',
                        valueField:'limitCompanyId',
                        model: options.model
                    }));
                }
            },
            {
                field: "limitDate",
                title: '<@spring.message "companylimit.limitdate"/>',
                width: 120,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {style: "text-align:center"},
                format: "{0:yyyy-MM-dd}",
                editor: function (container, options) {
                    var end = options.model.startDate;
                    var opts = {
                        format: "yyyy-MM-dd"
                    };
                    if (end) {
                        opts.max = end;
                    }
                    $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDatePicker(opts);
                },
                sortable: false
            },
            {
                field: "limitAmount",
                title: '<@spring.message "companylimit.limitamount"/>',
                width: 120
            },
            {
                field: "startDate",
                title: '<@spring.message "companylimit.startdate"/>',
                width: 120,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {style: "text-align:center"},
                format: "{0:yyyy-MM-dd}",
                editor: function (container, options) {
                    var end = options.model.startDate;
                    var opts = {
                        format: "yyyy-MM-dd"
                    };
                    if (end) {
                        opts.max = end;
                    }
                    $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDatePicker(opts);
                },
                sortable: false
            },
            {
                field: "endDate",
                title: '<@spring.message "companylimit.enddate"/>',
                width: 120,
                nullable:true,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {style: "text-align:center"},
                format: "{0:yyyy-MM-dd}",
                editor: function (container, options) {
                    var opts = {
                        format: "yyyy-MM-dd"
                    };

                    $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDatePicker(opts);
                },
                sortable: false
            },
            {
                field: "limitNote",
                title: '<@spring.message "companylimit.limitnote"/>',
                width: 120
            },
            {
                field: "enabledFlag",
                title: '<@spring.message "companylimit.enabledflag"/>',
                width: 120,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {style: "text-align:center"},
                sortable: false
            },
        ],
        editable: true
    });


    // 额度页面下一步 :保存额度信息并且切换到下一个页面
    function  content2nextStep(){
        var grid =  $("#grid").data("kendoGrid");
        grid.saveChanges();
        $('#content2').addClass("hidecontent");
        $('#content3').removeClass("hidecontent");
    }
    // 额度页面上一步
    function  content2prevStep(){
        $('#content2').addClass("hidecontent");
        $('#content1').removeClass("hidecontent");
    }
</script>
<script type="text/javascript">
    //附件页面上一步
    function  content3prevStep(){
        $('#content3').addClass("hidecontent");
        $('#content2').removeClass("hidecontent");
    }
    //附件上传所用的代码
    function convertToTree(datas){
        var map={};
        $.each(datas,function(i,r){
            map[r.categoryId]=r;
        });

        function build(d){
            if(d.parentCategoryId){
                var p = map[d.parentCategoryId];
                if(p){
                    var items = p.items||[];
                    if(items.indexOf(d)<0)
                        p.items=items.concat(d);
                    build(p);
                }
            }
        }

        $.each(datas,function(i,r){
            build(r);
        });
        var arr=[];
        $.each(map,function(i,r){
            arr.push(r);
        });
        return arr;
    }
    var datas=[];
    $.ajax({
        url: "${base.contextPath}/sys/attachment/category/queryTree",
        type: "post",
        dataType: "json",
        data:{
            "parentCategoryId" : "10001"
        },
        async:false,
        success:function(args){
            datas=convertToTree(args);
        }
    });

    $("#treeView").kendoTreeView({
        dataSource : {
            data:datas
        },
        template: function(e){
            if(e.item.leafFlag==='1'){
                return "<span onclick='searchFile(" + e.item.categoryId + ',"' + e.item.sourceType  + '"' + ")'  >"+  e.item.categoryName +"</span>";
            }else{
                return e.item.description;
            }
        }

    });
    var gridDataSource=new kendo.data.DataSource({
        transport:{
            read: {
                url: '${base.contextPath}/sys/attach/file/query',
                type: "post",
                dataType: "json"
            },
            destroy: {
                url: '${base.contextPath}/sys/attach/file/remove',
                contentType: "application/json",
                type : "POST"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    return kendo.stringify(options.models);
                }else if (type === "read") {
                    var map = {};
                    if (options) {
                        map.page = options.page;
                        map.pagesize = options.pageSize;
                        if (options.sort && options.sort.length > 0) {
                            map.sortname = options.sort[0].field;
                            map.sortorder = options.sort[0].dir;
                        }
                    }
                    map.categoryId = newViewModel.get("categoryId");
                    if(companyId != null){
                        map.sourceKey = companyId;
                    }else{
                        map.sourceKey = -1;
                    }
                    return map;
                }
            }
        },
        batch: true,
        serverPaging : true,
        serverSorting: true,
        pageSize: 20,
        schema: {
            model:{
                id:'fileId'
            },
            data:'rows',
            total:'total'
        }
    });

    var grid = $("#sysfile_grid").kendoGrid({
        dataSource: gridDataSource,
        navigatable: true,
        dataBound: function(){
            if(parent.autoResizeIframe){
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        resizable: true,
        sortable: true,
        scrollable: true,
        editable:false,
        selectable : 'multiple, rowbox',
        pageable: {
            pageSizes:[5, 10, 20, 50],
            refresh:true,
            buttonCount:5
        },
        toolbar: [
            {
                template:'<span  onclick="uploadFile()"  class="btn btn-primary"><i class="fa fa-upload" style="margin-right:3px;"></i><@spring.message "sysfile.upload"/></span>'
            },
            {
                template:'<span  onclick="deleteData()"  class="btn btn-danger"><i class="fa fa-trash-o" style="margin-right:3px;"></i><@spring.message "jrap.delete"/></span>'
            }
        ],
        columns: [
            { field: "fileName", title: '<@spring.message "sysfile.filename"/>', width: 160 },
            { field: "fileSize", title:'<@spring.message "sysfile.filesize"/>', width: 60 },
            { field: "uploadDate", title:'<@spring.message "sysfile.uploaddate"/>', width: 80 },
            { field: "fileType", title:'<@spring.message "sysfile.filetype"/>', width: 80 },
            {
                template:function(e){
                    return '<a target="_blank" href="${base.contextPath}/sys/attach/file/download?fileId='+ e.fileId+'&token='+ e._token+'"><@spring.message "jrap.download"/></a>';
                },width:30
            },
        ]
    }).data("kendoGrid");

    function searchFile(id, sourceType){
        newViewModel.set("categoryId",id);
        newViewModel.set("sourceType",sourceType);
        gridDataSource.page(1);
    }
    function uploadFile() {
        var sourceType = newViewModel.get("sourceType");
        var companyId = companyId;

        if(sourceType == "COMPANY_ID"){
            kendo.ui.showInfoDialog({
                message: '请选择具体的附件条目!'
            });
            return;
        }
        var importWin = $("#importWin").kendoWindow({
            title: '上传文件',
            width: 600,
            height: 200,
            modal: true,
            close: function () {
                $('#sysfile_grid').data('kendoGrid').dataSource.page(1);
            }
        }).data("kendoWindow");
        importWin.center().open();
    }

    function deleteData() {
        var checked = grid.selectedDataItems();
        if(grid.selectedDataItems().length){
            kendo.ui.showConfirmDialog({
                title:$l('jrap.tip.info'),
                message: $l('jrap.tip.delete_confirm')
            }).done(function (event) {
                if (event.button == 'OK') {
                    $.each(checked,function(i,v){
                        grid.dataSource.remove(v)
                    });
                    grid.dataSource.sync();
                }
            })
        }
    }
  // 提交申请，启动工作流
  function  applySubmit(){
      $.ajax({
          url: BaseUrl + '/wfl/runtime/processInstances/company/limit/apply',
          type: "POST",
          dataType: "json",
          contentType: "application/x-www-form-urlencoded; charset=UTF-8",
          data: {"companyId": companyId},
          success: function (args) {
                  kendo.ui.showInfoDialog({
                      title: "提示",
                      message: "商户入网申请成功！",
                  });
          }
      });
  }
</script>
</html>